---
name: Crear routing dinámico [slug]
status: closed
created: 2025-12-23T04:57:47Z
updated: 2025-12-23T05:06:22Z
github: https://github.com/javikin/choiz-website-cms-mx/issues/15
depends_on: [13, 14]
parallel: false
conflicts_with: []
---

# Task: Crear routing dinámico [slug]

## Description

Crear el routing dinámico en Next.js para renderizar las páginas creadas en TinaCMS. Incluye generación estática, manejo de drafts, y visual editing.

## Acceptance Criteria

- [ ] Archivo `src/app/[slug]/page.tsx` creado
- [ ] Páginas publicadas accesibles en `/{slug}`
- [ ] Páginas draft retornan 404
- [ ] Visual editing funciona en TinaCMS
- [ ] generateStaticParams genera rutas para páginas publicadas
- [ ] SEO metadata funciona correctamente

## Technical Details

### Archivo a crear
- `src/app/[slug]/page.tsx`

### Implementación

```typescript
import { notFound } from "next/navigation";
import client from "@/tina/__generated__/client";
import { LandingPageClient } from "@/components/LandingPageClient";

// Query GraphQL para páginas
// NOTA: Copiar estructura de sections del query en src/app/page.tsx
const pageQuery = `query page($relativePath: String!) {
  page(relativePath: $relativePath) {
    ... on Document {
      _sys { filename basename breadcrumbs path relativePath extension }
      id
    }
    __typename
    title
    status
    seo { __typename metaTitle metaDescription ogImage ogType canonicalUrl noIndex }
    navbar { __typename variant logo ctaText ctaLink loginLink }
    sections {
      __typename
      ... on PageSectionsHero { /* copiar de landing */ }
      ... on PageSectionsCertifications { /* copiar de landing */ }
      // ... todos los demás tipos de sección
    }
  }
}`;

// Generar rutas estáticas para páginas publicadas
export async function generateStaticParams() {
  try {
    const pagesResponse = await client.queries.pageConnection();
    const pages = pagesResponse.data.pageConnection.edges || [];

    return pages
      .filter((edge) => edge?.node?.status === "published")
      .map((edge) => ({
        slug: edge?.node?._sys.filename,
      }));
  } catch (error) {
    console.error("Error generating static params:", error);
    return [];
  }
}

// Metadata para SEO
export async function generateMetadata({ params }: { params: { slug: string } }) {
  try {
    const { slug } = params;
    const result = await client.queries.page({
      relativePath: `${slug}.json`,
    });

    const page = result.data.page;

    return {
      title: page?.seo?.metaTitle || page?.title,
      description: page?.seo?.metaDescription,
      openGraph: {
        title: page?.seo?.metaTitle || page?.title,
        description: page?.seo?.metaDescription,
        images: page?.seo?.ogImage ? [page.seo.ogImage] : [],
      },
    };
  } catch {
    return {};
  }
}

export default async function Page({ params }: { params: { slug: string } }) {
  const { slug } = params;

  try {
    const result = await client.queries.page({
      relativePath: `${slug}.json`,
    });

    // Verificar si la página existe
    if (!result.data.page) {
      notFound();
    }

    // Verificar estado draft (solo en producción)
    // En desarrollo/preview, TinaCMS maneja esto
    if (result.data.page.status === "draft" && process.env.NODE_ENV === "production") {
      notFound();
    }

    return (
      <LandingPageClient
        query={pageQuery}
        variables={{ relativePath: `${slug}.json` }}
        data={result.data}
      />
    );
  } catch (error) {
    console.error("Error loading page:", error);
    notFound();
  }
}
```

### Verificación
```bash
npm run dev

# 1. Crear página de prueba en TinaCMS
#    - Ir a /admin
#    - Landing Pages → Nueva
#    - Título: "Test Landing"
#    - Status: Published
#    - Agregar algunas secciones
#    - Guardar

# 2. Verificar página
#    - Navegar a /test-landing
#    - Verificar que se renderiza correctamente

# 3. Verificar draft
#    - Cambiar status a Draft
#    - Verificar que /test-landing retorna 404 en producción

# 4. Verificar visual editing
#    - En TinaCMS, editar la página
#    - Verificar que el preview funciona
```

## Dependencies

- [ ] Task 001: Templates extraídos
- [ ] Task 002: Colección page creada

## Effort Estimate

- Size: M
- Hours: 2
- Parallel: false (depende de Tasks 001 y 002)

## Definition of Done

- [ ] `src/app/[slug]/page.tsx` creado
- [ ] Páginas publicadas se renderizan correctamente
- [ ] Páginas draft retornan 404
- [ ] Visual editing funciona
- [ ] SEO metadata se genera correctamente
- [ ] Home (`/`) sigue funcionando
